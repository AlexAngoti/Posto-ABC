unit uMovAbastecimento;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Samples.Spin,
  Vcl.Imaging.pngimage, Vcl.ExtCtrls, Vcl.Buttons, Vcl.DBCtrls,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, Datasnap.DBClient,
  Datasnap.Provider, FireDAC.Comp.DataSet, FireDAC.Comp.Client, uBomba;

type
  TfrmMovAbastecimento = class(TForm)
    pnlSubTop: TPanel;
    btnFechar: TSpeedButton;
    imgLogoTop: TImage;
    pnlBotoes: TPanel;
    btnIniciar: TSpeedButton;
    btnCancelar: TSpeedButton;
    btnFinalizar: TSpeedButton;
    pnlCentrol: TPanel;
    lblLitros: TLabel;
    lblVlrTotal: TLabel;
    pnlTop: TPanel;
    lblTipoComb: TLabel;
    pnlLinha: TPanel;
    pnlBombaComb: TLabel;
    edtLitros: TEdit;
    edtValorTotal: TEdit;
    cbxTanque: TComboBox;
    cbxBomba: TComboBox;
    procedure edtValorTotalKeyPress(Sender: TObject; var Key: Char);
    procedure dsTanqueDataChange(Sender: TObject; Field: TField);
    procedure btnIniciarClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnFinalizarClick(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);
    procedure cdsTanqueAfterOpen(DataSet: TDataSet);
    procedure cdsBombaAfterOpen(DataSet: TDataSet);
  private
    procedure OpenDataSet;
    procedure OpenDataBomb;
    procedure LimpaCampo;
    procedure IniciaAbastecimento;
    procedure FinalizarAbastecimento;
    procedure CarregaTanque;
    procedure CarregaBomba;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmMovAbastecimento: TfrmMovAbastecimento;

implementation

uses
  uDm, uFuncoes, uAbastecimento, uIAbastecimentoRepositorio,
  uCalculoImpostoPadrao, uAbastecimentoRepositorioFD;

{$R *.dfm}

{ TfrmMovAbastecimento }

procedure TfrmMovAbastecimento.btnFecharClick(Sender: TObject);
begin
  Self.CLose;
end;

procedure TfrmMovAbastecimento.CarregaBomba;
var
  i: Integer;
begin
  cbxBomba.Items.Clear;

  for i := 0 to Pred(dm.ListaBombas.Count) do
    cbxBomba.Items.AddObject(dm.ListaBombas[i].Nome, dm.ListaBombas[i]);
end;

procedure TfrmMovAbastecimento.CarregaTanque;
var
  i: Integer;
begin
  cbxTanque.Items.Clear;

  for i := 0 to Pred(dm.ListaTanques.Count) do
    cbxTanque.Items.AddObject(dm.ListaTanques[i].Nome, dm.ListaTanques[i]);
end;

procedure TfrmMovAbastecimento.edtValorTotalKeyPress(Sender: TObject;
  var Key: Char);
begin
  if not (Key in ['0'..'9', ',', #8]) then
  begin
    Key := #0;
  end;

  if (Key = ',') and (Pos(',', TEdit(Sender).Text) > 0) then
  begin
    Key := #0;
  end;
end;

procedure TfrmMovAbastecimento.FinalizarAbastecimento;
var
  Abastecimento: TAbastecimento;
  Repo: IAbastecimentoRepositorio;
  BombaSel: TBomba;
begin
  Abastecimento := TAbastecimento.Create(TCalculoImpostoPadrao.Create);
  try
    Abastecimento.ValorTotal := StrToFloat(edtValorTotal.Text);
    Abastecimento.Litros     := StrToFloat(edtLitros.Text);

    BombaSel := TBomba(cbxBomba.Items.Objects[cbxBomba.ItemIndex]);

    Abastecimento.Bomba.Id          := BombaSel.Id;
    Abastecimento.Bomba.Nome        := BombaSel.Nome;
    Abastecimento.Bomba.Tanque.Id   := BombaSel.Tanque.Id;
    Abastecimento.Bomba.Tanque.Nome := BombaSel.Tanque.Nome;

    Abastecimento.CalcularImposto;

    Repo := TAbastecimentoRepositorioFD.Create;
    Repo.Inserir(Abastecimento);
  finally
    Abastecimento.Free;
  end;

  ShowMessage('Abastecimento Finalizado com Sucesso!');
  Self.OpenDataSet;
  Self.LimpaCampo;
  DesabilitarControles(Self);
end;

procedure TfrmMovAbastecimento.FormShow(Sender: TObject);
begin
  Self.OpenDataSet;
  DesabilitarControles(Self);
end;

procedure TfrmMovAbastecimento.IniciaAbastecimento;
begin
  HabilitarControles(Self);
end;

procedure TfrmMovAbastecimento.LimpaCampo;
begin
  edtLitros.Text     := '0';
  edtValorTotal.Text := '0';
end;

procedure TfrmMovAbastecimento.OpenDataBomb;
begin
  Self.CarregaBomba;
end;

procedure TfrmMovAbastecimento.OpenDataSet;
begin
  Self.CarregaTanque;
end;

procedure TfrmMovAbastecimento.btnIniciarClick(Sender: TObject);
begin
  Self.IniciaAbastecimento;
end;

procedure TfrmMovAbastecimento.btnCancelarClick(Sender: TObject);
begin
  if Application.MessageBox('Deseja realmente cancelar esse abastecimento?', 'Confirmação', MB_ICONQUESTION + MB_YESNO) = IDYES then
   begin
     Self.OpenDataSet;
     Self.LimpaCampo;
     DesabilitarControles(Self);
   end;
end;

procedure TfrmMovAbastecimento.btnFinalizarClick(Sender: TObject);
begin
  Self.FinalizarAbastecimento;
end;

end.
